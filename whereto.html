<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <!--#include virtual="/~castaway/_includes/ga.html" -->
        <meta name="Author" content="Jess Robinson"/>
        <link rel="stylesheet" href="/~castaway/web/css/fonts.css" type="text/css" media="screen, projection">
        <link rel="stylesheet" href="/~castaway/web/css/my.css" type="text/css" media="screen, projection">
        <title>Where can I get to from here?</title>
        <link rel="stylesheet" href="http://openlayers.org/dev/theme/default/style.css" type="text/css" />
        <link rel="stylesheet" href="style.css" type="text/css" />


        <script type="text/javascript">
          /* <![CDATA[ */
    (function() {
        var s = document.createElement('script'), t =
    document.getElementsByTagName('script')[0];
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';
        t.parentNode.insertBefore(s, t);
    })();
/* ]]> */
        </script>

        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script src="http://openlayers.org/api/OpenLayers.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <script type="text/javascript">

            var map;

// Various projection/centring messing courtesy of:
// http://openlayers.org/dev/examples/sundials-spherical-mercator.html

            function init(){
               map = new OpenLayers.Map({
                 div: 'map',
                 projection: new OpenLayers.Projection("EPSG:900913"),
                 displayProjection: new OpenLayers.Projection("EPSG:4326"),
                 units: "m",
                 maxResolution: 156543.0339,
                 maxExtent: new OpenLayers.Bounds(
                   -20037508, -20037508, 20037508, 20037508.34
                 )
               });

                map.addControl(new OpenLayers.Control.LayerSwitcher());
                map.addControl(new OpenLayers.Control.PanZoomBar() );

                var osm = new OpenLayers.Layer.OSM();
                var gmap = new OpenLayers.Layer.Google("Google Streets", {visibility: false});
                map.addLayers([osm, gmap]);

                map.setCenter(
                  new OpenLayers.LonLat(-6.32894, 52.800525).transform(
                    new OpenLayers.Projection("EPSG:4326"),
                    map.getProjectionObject()
                  ), 
                6
                );


                load_data();
            }
             

            // Needed only for interaction, not for the display.
            function onPopupClose(evt) {
                // 'this' is the popup.
                selectControl.unselect(this.feature);
            }
            function onFeatureSelect(evt) {
                feature = evt.feature;
                popup = new OpenLayers.Popup.FramedCloud("featurePopup",
                                         feature.geometry.getBounds().getCenterLonLat(),
                                         new OpenLayers.Size(100,100),
                                         "<h2>"+feature.attributes.title + "</h2>" +
                                         feature.attributes.description,
                                         null, true, onPopupClose);
                feature.popup = popup;
                popup.feature = feature;
                map.addPopup(popup);
            }
            function onFeatureUnselect(evt) {
                feature = evt.feature;
                if (feature.popup) {
                    popup.feature = null;
                    map.removePopup(feature.popup);
                    feature.popup.destroy();
                    feature.popup = null;
                }
            }

        function load_data() {
            var start_params = jQuery('#startdata').serialize();

            var layer = new OpenLayers.Layer.Vector("WhereTo", {
            projection: map.displayProjection,
            //strategies: [new OpenLayers.Strategy.BBOX({resFactor: 1.1})],
            strategies: [new OpenLayers.Strategy.Fixed()],
            protocol: new OpenLayers.Protocol.HTTP({
            //url: "/~theorb/cgi-bin/whereto.cgi?" + start_params,
            url: "http://lilith.local/~theorb/whereto/foo.tsv",
            format: new OpenLayers.Format.Text()
            })
            
            });

            map.addLayers([layer]);

            // FIXME: This doesn't really belong in load_data, but has
            // to be, because layer isn't in scope in init().  Should
            // really make the layer in init, but only populate it later.
            // Interaction; not needed for initial display.
            selectControl = new OpenLayers.Control.SelectFeature(layer);
            map.addControl(selectControl);
            selectControl.activate();
            layer.events.on({
               'featureselected': onFeatureSelect,
               'featureunselected': onFeatureUnselect
            });

            return false;
        }

        </script>

    </head>
    <body onload="init()">
        <h1 id="title">Where To From Here</h1>

        
        <p>Showing a map of where you can walk/drive/cycle to, on
        actual streets and paths</p>
        <div id="map"></div>

        <div class="monitization" style="float: right">
          Like this?  Show your appreciation!<br/>
          Give me money: 
            <a class="FlattrButton" style="display:none;"
               rev="flattr;button:compact;"
               href="http://desert-island.me.uk/~theorb/whereto/"></a>
            <noscript><a href="http://flattr.com/thing/465248/Where-to"
                         target="_blank">
                <img src="http://api.flattr.com/button/flattr-badge-large.png"
                     alt="Flattr this" title="Flattr this" border="0"
                     /></a></noscript>        
          <br/>
          Tweet about it: <a href="https://twitter.com/share"
          class="twitter-share-button" data-via="theorbtwo">Tweet</a>
<script>!function(d,s,id){var
  js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script><br />
        </div>

        <p>
          <form id="startdata" action="" onsubmit="load_data()">
          <h3>Start Point</h3>
          <div>
            <span><label for="id_latitude">Latitude</label><input id="id_latitude" name="latitude" type="text" value=""/></span>
            <span><label for="id_longitude">Longitude</label><input id="id_longitude" type="text" name="longitude" value=""/></span>
          </div>
          <div><label for="id_distance">Distance (miles)</label><input id="id_distance" name="distance" type="text" value=""/></div>
          <input type="submit" value="Show me!"/>
          </form>
        </p>

        <p>Authors: <a href="http://boardgamegeek.com/user/castaway">Jess Robinson</a> and <a href="http://boardgamegeek.com/user/theorbtwo">James Mastros</a>. <a href="mailto:jandj@desert-island.me.uk">Email</a> or BGG PM us comments or requests for data in other countries</p>
        <p><small><a href="/~castaway/web">Home</a></small></p>

    </body>
</html>
